
# Configure a default setup of Home Assistant (frontend, api, etc)
default_config:

# Text to speech
tts:
  - platform: google_translate
    base_url: https://homeassistant.jlaska.com

group: !include groups.yaml
automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml

homeassistant:
  customize: !include customize.yaml

# Include themes directory
frontend:
  themes: !include_dir_merge_named themes

logger:
  default: warn

# LFX UDP broadcast isn't working on my network
lifx:
  light:
    - broadcast: !secret lifx_mini_ip
    - broadcast: !secret lifx_z_1_ip
    - broadcast: !secret lifx_z_2_ip

sensor:
  - platform: template
    sensors:
      # Create a virtual lux sensor
      solar_luminance:
        friendly_name: "Solar Luminance"
        icon_template: "mdi:brightness-auto"
        unit_of_measurement: lx
        value_template: "{{ states('sensor.solaredge_current_power') }}"
        device_class: illuminance
      # Create several time/date sensors for use in dashboards
      time_hhmm:
        friendly_name: "Time (hh:mm)"
        icon_template: mdi:calendar-clock
        value_template: "{{ as_timestamp(states('sensor.date_time_iso')) | timestamp_custom('%-I:%M %p') }}"
      my_date:
        friendly_name: "Date (friendly)"
        icon_template: mdi:calendar
        value_template: "{{ as_timestamp(states('sensor.date_time_iso')) | timestamp_custom('%A, %B %d') }}"

  # Create time sensors
  - platform: time_date
    display_options:
      - 'time'
      - 'date'
      - 'date_time'
      - 'date_time_iso'
      - 'time_date'

binary_sensor:
  # Create humidistat sensors (https://github.com/basschipper/homeassistant-generic-hygrostat)
  - platform: generic_hygrostat
    name: Master Bathroom Hygrostat
    sensor: sensor.lumi_lumi_weather_humidity
    delta_trigger: 3 # Optional humidity swing to detect. Default = 3
    target_offset: 3 # Optional dehumidification target offset. Default = 3
    max_on_time: 2700 # Optional safety max on time in seconds. Default = 7200 seconds
    sample_interval: 300 # Optional time between taking humidity samples in seconds, default 300 seconds
    min_humidity: 30 # Optional minimum humidity to enable dehumidification. Default = 0
  - platform: generic_hygrostat
    name: Guest Bathroom Hygrostat
    sensor: sensor.lumi_lumi_weather_30fe7b06_humidity
    max_on_time: 2700
  - platform: generic_hygrostat
    name: Kids Bathroom Hygrostat
    sensor: sensor.lumi_lumi_weather_4c017c06_humidity
    max_on_time: 2700
  # Consolidate motion sensors for rooms that have multiple sensors
  - platform: template
    sensors:
      garage_motion_any:
        friendly_name: "Garage Motion (any)"
        device_class: motion
        unique_id: binary_sensor.garage_motion_any
        value_template: >-
          {{ is_state('binary_sensor.garage_motion_ias_zone', 'on')
             or is_state('binary_sensor.motion_garage_protect', 'on') }}
      living_room_motion_any:
        friendly_name: "Living Room Motion (any)"
        device_class: motion
        unique_id: binary_sensor.living_room_motion_any
        value_template: >-
          {{ is_state('binary_sensor.living_room_motion_ias_zone', 'on')
             or is_state('binary_sensor.motion_living_room_protect', 'on') }}
      sunroom_motion_any:
        friendly_name: "Sunroom Motion (any)"
        device_class: motion
        unique_id: binary_sensor.sunroom_motion_any
        value_template: >-
          {{ is_state('binary_sensor.motion_sunroom_protect', 'on')
             or is_state('binary_sensor.sunroom_motion_ias_zone', 'on') }}
      dining_room_motion_any:
        friendly_name: "Dining Room Motion (any)"
        device_class: motion
        unique_id: binary_sensor.dining_room_motion_any
        value_template: >-
          {{ is_state('binary_sensor.dining_room_motion_ias_zone', 'on')
             or is_state('binary_sensor.motion_dining_room_protect', 'on') }}
      downstairs_motion_any:
        friendly_name: "Downstairs Motion (any)"
        device_class: motion
        unique_id: binary_sensor.downstairs_motion_any
        value_template: >-
          {{ is_state('binary_sensor.dining_room_motion_ias_zone', 'on')
             or is_state('binary_sensor.kitchen_motion_ias_zone', 'on')
             or is_state('binary_sensor.living_room_motion_ias_zone', 'on')
             or is_state('binary_sensor.motion_dining_room_protect', 'on')
             or is_state('binary_sensor.motion_living_room_protect', 'on')
             or is_state('binary_sensor.motion_sunroom_protect', 'on')
             or is_state('binary_sensor.mudroom_motion_ias_zone', 'on')
             or is_state('binary_sensor.sunroom_motion_ias_zone', 'on')
             or is_state('binary_sensor.motion_dining_room_protect', 'on') }}

light:
  # Combine multiple lights into one
  - platform: group
    name: Living Room Bookshelf
    entities:
      - light.living_room_bookshelf_left
      - light.living_room_bookshelf_right

  # Convert switches to a light
  - platform: switch
    name: Back Door Light
    entity_id: switch.back_door_light_switch
  - platform: switch
    name: Back Spot Light
    entity_id: switch.back_spot_light_switch
  - platform: switch
    name: Entryway Door Light
    entity_id: switch.entryway_door_light_switch
  - platform: switch
    name: Entryway Hall Light
    entity_id: switch.entryway_hall_light_switch
  - platform: switch
    name: Front Door Light
    entity_id: switch.front_door_light_switch
  - platform: switch
    name: Front Spot Light
    entity_id: switch.front_spot_light_switch
  - platform: switch
    name: Garage Exterior Light
    entity_id: switch.garage_exterior_light_switch
  - platform: switch
    name: Garage Light
    entity_id: switch.garage_light_switch
  - platform: switch
    name: Garage Work Light
    entity_id: switch.garage_work_light_switch
  - platform: switch
    name: Guest Bathroom Light
    entity_id: switch.guest_bathroom_light_switch
  - platform: switch
    name: Guest Room Fan Light
    entity_id: switch.guest_room_fan_light_switch
  - platform: switch
    name: Guest Room Nightstand
    entity_id: switch.guest_room_nightstand_switch
  - platform: switch
    name: Henry's Room Fan Light
    entity_id: switch.henrys_room_fan_light_switch
  - platform: switch
    name: Holiday Lights
    entity_id: switch.holiday_light_switch
  - platform: switch
    name: Kids Bathroom Light
    entity_id: switch.kids_bathroom_light_switch
  - platform: switch
    name: Kitchen Table Light
    entity_id: switch.kitchen_table_light_switch
  - platform: switch
    name: Laundry Room Light
    entity_id: switch.laundry_room_light_switch
  - platform: switch
    name: Living Room Fan Light
    entity_id: switch.living_room_fan_light_switch
  - platform: switch
    name: Master Bathroom Light
    entity_id: switch.master_bathroom_light_switch
  - platform: switch
    name: Master Bathroom Shower Light
    entity_id: switch.master_bathroom_shower_light_switch
  - platform: switch
    name: Master Bedroom Fan Light
    entity_id: switch.master_bedroom_fan_light_switch
  - platform: switch
    name: Master Bedroom Nightstand
    entity_id: switch.master_bedroom_nightstand_switch
  - platform: switch
    name: Mudroom Light
    entity_id: switch.mudroom_light_switch
  - platform: switch
    name: Sunroom Fan Light
    entity_id: switch.sunroom_fan_light_switch
  - platform: switch
    name: William's Room Fan Light
    entity_id: switch.williams_room_fan_light_switch
  - platform: switch
    name: Shannon's Closet Light
    entity_id: switch.shannons_closet_light_switch
  - platform: switch
    name: Master Bathroom Toilet Light
    entity_id: switch.master_bathroom_toilet_light_switch

fan:
  - platform: template
    fans:
      guest_bathroom_fan:
        friendly_name: "Guest Bathroom Fan"
        unique_id: "fan.guest_bathroom_fan"
        value_template: "{{ states('switch.guest_bathroom_fan_switch') }}"
        speed_count: 1
        turn_on:
          service: 'switch.turn_on'
          entity_id: 'switch.guest_bathroom_fan_switch'
        turn_off:
          service: 'switch.turn_off'
          entity_id: 'switch.guest_bathroom_fan_switch'
      guest_room_fan:
        friendly_name: "Guest Room Fan"
        unique_id: "fan.guest_room_fan"
        value_template: "{{ states('switch.guest_room_fan_switch') }}"
        speed_count: 1
        turn_on:
          service: 'switch.turn_on'
          entity_id: 'switch.guest_room_fan_switch'
        turn_off:
          service: 'switch.turn_off'
          entity_id: 'switch.guest_room_fan_switch'
      henrys_room_fan:
        friendly_name: "Henry's Room Fan"
        unique_id: "fan.henrys_room_fan"
        value_template: "{{ states('switch.henrys_room_fan_switch') }}"
        speed_count: 1
        turn_on:
          service: 'switch.turn_on'
          entity_id: 'switch.henrys_room_fan_switch'
        turn_off:
          service: 'switch.turn_off'
          entity_id: 'switch.henrys_room_fan_switch'
      living_room_fan:
        friendly_name: "Living Room Fan"
        unique_id: "fan.living_room_fan"
        value_template: "{{ states('switch.living_room_fan_switch') }}"
        speed_count: 1
        turn_on:
          service: 'switch.turn_on'
          entity_id: 'switch.living_room_fan_switch'
        turn_off:
          service: 'switch.turn_off'
          entity_id: 'switch.living_room_fan_switch'
      master_bathroom_fan:
        friendly_name: "Master Bathroom Fan"
        unique_id: "fan.master_bathroom_fan"
        value_template: "{{ states('switch.master_bathroom_fan_switch') }}"
        speed_count: 1
        turn_on:
          service: 'switch.turn_on'
          entity_id: 'switch.master_bathroom_fan_switch'
        turn_off:
          service: 'switch.turn_off'
          entity_id: 'switch.master_bathroom_fan_switch'
      master_bathroom_toilet_fan:
        friendly_name: "Master Bathroom Toilet Fan"
        unique_id: "fan.master_bathroom_toilet_fan"
        value_template: "{{ states('switch.master_bathroom_toilet_fan_switch') }}"
        speed_count: 1
        turn_on:
          service: 'switch.turn_on'
          entity_id: 'switch.master_bathroom_toilet_fan_switch'
        turn_off:
          service: 'switch.turn_off'
          entity_id: 'switch.master_bathroom_toilet_fan_switch'
      master_bedroom_fan:
        friendly_name: "Master Bedroom Fan"
        unique_id: "fan.master_bedroom_fan"
        value_template: "{{ states('switch.master_bedroom_fan_switch') }}"
        speed_count: 1
        turn_on:
          service: 'switch.turn_on'
          entity_id: 'switch.master_bedroom_fan_switch'
        turn_off:
          service: 'switch.turn_off'
          entity_id: 'switch.master_bedroom_fan_switch'
      sunroom_fan:
        friendly_name: "Sunroom Fan"
        unique_id: "fan.sunroom_fan"
        value_template: "{{ states('switch.sunroom_fan_switch') }}"
        speed_count: 1
        turn_on:
          service: 'switch.turn_on'
          entity_id: 'switch.sunroom_fan_switch'
        turn_off:
          service: 'switch.turn_off'
          entity_id: 'switch.sunroom_fan_switch'
      williams_room_fan:
        friendly_name: "William's Room Fan"
        unique_id: "fan.williams_room_fan"
        value_template: "{{ states('switch.williams_room_fan_switch') }}"
        speed_count: 1
        turn_on:
          service: 'switch.turn_on'
          entity_id: 'switch.williams_room_fan_switch'
        turn_off:
          service: 'switch.turn_off'
          entity_id: 'switch.williams_room_fan_switch'

# Fix GE dimmer switch polling
zwave:
  usb_path: /dev/ttyUSB0
  network_key: !secret zwave_network_key
  device_config:
    light.master_bedroom_light_level:
      refresh_value: true
      polling_intensity: 1
      delay: 4
    light.dining_room_light_level:
      refresh_value: true
      polling_intensity: 1
      delay: 4
    light.kitchen_cabinet_light_level:
      refresh_value: true
      polling_intensity: 1
      delay: 4
    light.kitchen_island_light_level:
      refresh_value: true
      polling_intensity: 1
      delay: 4
    light.kitchen_light_level:
      refresh_value: true
      polling_intensity: 1
      delay: 4
    light.living_room_light_level:
      refresh_value: true
      polling_intensity: 1
      delay: 4
    light.williams_room_light_level:
      refresh_value: true
      polling_intensity: 1
      delay: 4

# Google Nest Integration
nest:
  client_id: !secret google_client_id
  client_secret: !secret google_client_secret
  project_id: !secret google_project_id
  subscriber_id: !secret google_subscriber_id

# Use camera plugin for forcast/doplar images
camera:
  - platform: generic
    still_image_url: !secret weather_doplar_url
    name: Weather Doplar Radar
  - platform: generic
    still_image_url: !secret weather_forecast_url
    name: Weather 7 Day Forecast

homekit:
  - filter:
      include_domains:
        - light
        - fan
      include_entity_globs:
        - switch.*_on_off
        - binary_sensor.*_ias_zone
      exclude_entities:
        - light.living_room_table_lamp
      exclude_entity_globs:
        - light.living_room_bookshelf*
